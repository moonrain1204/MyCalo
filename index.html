<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyCalo v1.0.8 - 視覺化與再次編輯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        ::-webkit-scrollbar { display: none; }
        .drawer-active { transform: translateY(0) !important; }
        .modal-bg { background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }
        .food-thumb { width: 50px; height: 50px; object-fit: cover; border-radius: 12px; background: #f1f5f9; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900 select-none">

    <div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-2xl relative pb-32">
        
        <header class="p-8 bg-gradient-to-br from-indigo-600 to-blue-500 text-white rounded-b-[2.5rem] shadow-xl">
            <div class="flex justify-between items-center mb-6">
                <div class="text-sm font-light opacity-90" id="headerDate">2026年1月1日</div>
                <button onclick="toggleUserModal(true)" class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center"><i class="fas fa-user-cog"></i></button>
            </div>
            <div class="flex items-center justify-around">
                <div class="relative">
                    <svg class="w-32 h-32 -rotate-90">
                        <circle cx="64" cy="64" r="58" stroke="rgba(255,255,255,0.2)" stroke-width="8" fill="transparent" />
                        <circle id="progressCircle" cx="64" cy="64" r="58" stroke="white" stroke-width="8" fill="transparent" stroke-dasharray="364" stroke-dashoffset="364" stroke-linecap="round" class="transition-all duration-700" />
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <span id="displayKcal" class="text-3xl font-bold">0</span>
                        <p class="text-[10px] opacity-80 uppercase">今日攝取 kcal</p>
                    </div>
                </div>
                <div class="space-y-1 text-sm">
                    <div class="text-[10px] opacity-70">預算: <span id="budgetDisplay">1500</span> kcal</div>
                    <div class="w-32 flex justify-between border-b border-white/10"><span>碳水</span><span id="statCarb">0g</span></div>
                    <div class="w-32 flex justify-between border-b border-white/10"><span>蛋白</span><span id="statPro">0g</span></div>
                    <div class="w-32 flex justify-between"><span>脂肪</span><span id="statFat">0g</span></div>
                </div>
            </div>
        </header>

        <main class="p-6 space-y-4">
            <h3 class="text-xl font-bold text-gray-800">用餐紀錄</h3>
            <div id="mealList" class="space-y-3"></div>
        </main>

        <div id="searchDrawer" class="fixed inset-0 bg-black/60 z-50 hidden backdrop-blur-sm transition-opacity">
            <div id="drawerContent" class="absolute bottom-0 w-full max-w-md bg-white rounded-t-[2.5rem] p-6 max-h-[95vh] overflow-y-auto transform translate-y-full transition-transform duration-500">
                <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
                <h2 id="drawerTitle" class="text-2xl font-bold mb-4 text-slate-800">紀錄食品內容</h2>
                
                <input type="hidden" id="editingId">
                <input type="text" id="foodInput" class="w-full bg-gray-100 rounded-2xl p-4 mb-4 outline-none border-2 border-transparent focus:border-indigo-400" placeholder="點此輸入名稱 (如: 味味麵)">
                
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <button onclick="searchGoogle()" class="bg-white border p-3 rounded-xl flex items-center justify-center shadow-sm"><img src="https://www.google.com/favicon.ico" class="w-4 h-4 mr-2"> Google</button>
                    <label class="bg-white border p-3 rounded-xl flex items-center justify-center shadow-sm cursor-pointer"><i class="fas fa-camera mr-2 text-indigo-500"></i> 上傳截圖<input type="file" id="screenshotUpload" class="hidden" accept="image/*" onchange="processImage(this)"></label>
                </div>

                <div id="imagePreview" class="w-full h-32 bg-slate-50 rounded-2xl mb-4 flex items-center justify-center overflow-hidden border-2 border-dashed border-slate-200">
                    <span class="text-slate-400 text-sm">尚未上傳圖片</span>
                </div>

                <div class="bg-indigo-50 p-5 rounded-3xl space-y-4 mb-6">
                    <div class="flex gap-4">
                        <div class="flex-1"><label class="text-[10px] text-indigo-400 font-bold ml-1 uppercase">熱量 (Kcal)</label><input type="number" id="inputKcal" class="w-full bg-white rounded-xl p-3 text-xl font-bold text-indigo-600 outline-none"></div>
                        <div class="w-24"><label class="text-[10px] text-indigo-400 font-bold ml-1 uppercase">份數</label><input type="number" id="inputQty" value="1" class="w-full bg-white rounded-xl p-3 text-center font-bold outline-none"></div>
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                        <input type="number" id="inputCarb" class="bg-white rounded-xl p-2 text-center text-sm outline-none" placeholder="碳水">
                        <input type="number" id="inputPro" class="bg-white rounded-xl p-2 text-center text-sm outline-none" placeholder="蛋白">
                        <input type="number" id="inputFat" class="bg-white rounded-xl p-2 text-center text-sm outline-none" placeholder="脂肪">
                    </div>
                </div>

                <button onclick="saveToRecord()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-indigo-200 active:scale-95 transition-all mb-3">儲存紀錄</button>
                <button onclick="toggleDrawer(false)" class="w-full text-slate-400 text-sm">取消</button>
            </div>
        </div>

        <div id="userModal" class="fixed inset-0 z-[60] hidden modal-bg flex items-center justify-center p-6">...</div>

        <div class="fixed bottom-1 left-1 opacity-20 text-[8px] z-0">v1.0.8-beta</div>
        <nav class="fixed bottom-0 max-w-md w-full bg-white/90 backdrop-blur-md border-t border-gray-100 p-4 flex justify-around items-center z-40">
            <i class="fas fa-home text-indigo-500 text-xl"></i>
            <div onclick="openAddDrawer()" class="w-12 h-12 bg-indigo-500 rounded-full -mt-10 border-4 border-white flex items-center justify-center text-white shadow-lg cursor-pointer"><i class="fas fa-plus"></i></div>
            <i onclick="toggleUserModal(true)" class="fas fa-cog text-gray-300 text-xl cursor-pointer"></i>
        </nav>
    </div>

    <script>
        let records = JSON.parse(localStorage.getItem('myCaloRecords')) || [];
        let userInfo = JSON.parse(localStorage.getItem('myCaloUserInfo')) || { name: '', gender: 'male', height: 170, weight: 65, age: 25, bmr: 1500 };
        let currentImageData = null;

        window.onload = () => {
            calculateAll();
            document.getElementById('headerDate').innerText = new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
        };

        // --- 圖片處理 ---
        function processImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentImageData = e.target.result;
                    document.getElementById('imagePreview').innerHTML = `<img src="${currentImageData}" class="w-full h-full object-cover">`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- 紀錄管理 ---
        function openAddDrawer() {
            document.getElementById('editingId').value = "";
            document.getElementById('drawerTitle').innerText = "紀錄食品內容";
            document.getElementById('foodInput').value = "";
            document.getElementById('inputKcal').value = "";
            document.getElementById('inputQty').value = "1";
            document.getElementById('imagePreview').innerHTML = `<span class="text-slate-400 text-sm">尚未上傳圖片</span>`;
            currentImageData = null;
            toggleDrawer(true);
        }

        function editRecord(id) {
            const record = records.find(r => r.id === id);
            if (!record) return;
            document.getElementById('editingId').value = record.id;
            document.getElementById('drawerTitle').innerText = "編輯紀錄內容";
            document.getElementById('foodInput').value = record.name;
            document.getElementById('inputKcal').value = record.kcalRaw; // 原始單包數值
            document.getElementById('inputQty').value = record.qty;
            document.getElementById('inputCarb').value = record.carbRaw;
            document.getElementById('inputPro').value = record.proRaw;
            document.getElementById('inputFat').value = record.fatRaw;
            currentImageData = record.img || null;
            
            if(currentImageData) {
                document.getElementById('imagePreview').innerHTML = `<img src="${currentImageData}" class="w-full h-full object-cover">`;
            } else {
                document.getElementById('imagePreview').innerHTML = `<span class="text-slate-400 text-sm">尚未上傳圖片</span>`;
            }
            toggleDrawer(true);
        }

        function saveToRecord() {
            const editId = document.getElementById('editingId').value;
            const qty = parseFloat(document.getElementById('inputQty').value) || 1;
            const kcalRaw = parseFloat(document.getElementById('inputKcal').value) || 0;
            const carbRaw = parseFloat(document.getElementById('inputCarb').value) || 0;
            const proRaw = parseFloat(document.getElementById('inputPro').value) || 0;
            const fatRaw = parseFloat(document.getElementById('inputFat').value) || 0;

            const recordData = {
                id: editId ? parseInt(editId) : Date.now(),
                name: document.getElementById('foodInput').value || "紀錄食品",
                qty: qty,
                kcalRaw: kcalRaw, carbRaw: carbRaw, proRaw: proRaw, fatRaw: fatRaw,
                kcal: kcalRaw * qty,
                carb: carbRaw * qty,
                pro: proRaw * qty,
                fat: fatRaw * qty,
                img: currentImageData
            };

            if (editId) {
                const idx = records.findIndex(r => r.id === parseInt(editId));
                records[idx] = recordData;
            } else {
                records.push(recordData);
            }

            localStorage.setItem('myCaloRecords', JSON.stringify(records));
            calculateAll();
            toggleDrawer(false);
        }

        function renderList() {
            const list = document.getElementById('mealList');
            list.innerHTML = records.length === 0 ? '<div class="text-center py-10 text-gray-400 italic text-sm">尚未有攝取紀錄</div>' : '';
            
            records.slice().reverse().forEach(record => {
                const item = document.createElement('div');
                item.className = "bg-white p-3 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4 transition-all active:bg-slate-50";
                
                // 圖片部分
                const imgHTML = record.img 
                    ? `<img src="${record.img}" class="food-thumb">` 
                    : `<div class="food-thumb flex items-center justify-center bg-slate-100 text-slate-300"><i class="fas fa-utensils"></i></div>`;
                
                item.innerHTML = `
                    ${imgHTML}
                    <div class="flex-1" onclick="editRecord(${record.id})">
                        <div class="font-bold text-slate-700 leading-tight">${record.name}</div>
                        <div class="text-[10px] text-slate-400 mt-1">${record.qty} 份 | 點擊編輯</div>
                    </div>
                    <div class="text-right">
                        <div class="text-indigo-600 font-black">${Math.round(record.kcal)}</div>
                        <div class="text-[8px] text-slate-400 uppercase">kcal</div>
                    </div>
                `;
                
                // 長按刪除邏輯
                let timer;
                item.addEventListener('touchstart', () => timer = setTimeout(() => deleteRecord(record.id), 800));
                item.addEventListener('touchend', () => clearTimeout(timer));
                list.appendChild(item);
            });
        }

        // --- 其餘輔助函數 (BMR計算、Drawer切換、搜尋) 與 v1.0.7 相同 ---
        function deleteRecord(id) { if(confirm("確定刪除此紀錄？")) { records = records.filter(r => r.id !== id); localStorage.setItem('myCaloRecords', JSON.stringify(records)); calculateAll(); } }
        function calculateAll() { 
            const stats = records.reduce((acc, r) => ({ kcal: acc.kcal + r.kcal, carb: acc.carb + r.carb, pro: acc.pro + r.pro, fat: acc.fat + r.fat }), { kcal: 0, carb: 0, pro: 0, fat: 0 });
            document.getElementById('displayKcal').innerText = Math.round(stats.kcal);
            document.getElementById('statCarb').innerText = Math.round(stats.carb) + 'g';
            document.getElementById('statPro').innerText = Math.round(stats.pro) + 'g';
            document.getElementById('statFat').innerText = Math.round(stats.fat) + 'g';
            document.getElementById('budgetDisplay').innerText = userInfo.bmr;
            const ratio = Math.min(stats.kcal / userInfo.bmr, 1);
            document.getElementById('progressCircle').style.strokeDashoffset = 364 - (ratio * 364);
            renderList();
        }
        function toggleDrawer(show) {
            const drawer = document.getElementById('searchDrawer');
            if (show) { drawer.classList.remove('hidden'); setTimeout(() => document.getElementById('drawerContent').classList.add('drawer-active'), 10); }
            else { document.getElementById('drawerContent').classList.remove('drawer-active'); setTimeout(() => drawer.classList.add('hidden'), 500); }
        }
        function searchGoogle() { window.open(`https://www.google.com/search?q=${encodeURIComponent(document.getElementById('foodInput').value || '食品' + ' 熱量 營養成分')}`, '_blank'); }
    </script>
</body>
</html>
