<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyCalo v1.1.5 - 高精度 OCR 版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js'></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .input-success { border-color: #22c55e !important; background-color: #f0fdf4 !important; transition: all 0.5s; }
        .drawer-active { transform: translateY(0) !important; }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900">

    <div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-2xl relative pb-32">
        
        <header class="p-8 bg-gradient-to-br from-indigo-700 to-blue-600 text-white rounded-b-[3rem] shadow-xl relative">
            <div class="flex justify-between items-center mb-6">
                <div class="text-sm font-medium opacity-80" id="headerDate">載入中...</div>
                <button onclick="toggleUserModal(true)" class="w-12 h-12 flex items-center justify-center bg-white/10 rounded-full active:scale-90 transition-all">
                    <i class="fas fa-user-cog text-xl"></i>
                </button>
            </div>
            <div class="flex items-center justify-around">
                <div class="relative">
                    <svg class="w-32 h-32 -rotate-90">
                        <circle cx="64" cy="64" r="58" stroke="rgba(255,255,255,0.2)" stroke-width="8" fill="transparent" />
                        <circle id="progressCircle" cx="64" cy="64" r="58" stroke="white" stroke-width="8" fill="transparent" stroke-dasharray="364" stroke-dashoffset="364" stroke-linecap="round" class="transition-all duration-1000" />
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <span id="displayKcal" class="text-3xl font-black">0</span>
                        <p class="text-[10px] opacity-70">今日攝取</p>
                    </div>
                </div>
                <div class="text-sm space-y-1">
                    <div class="flex justify-between w-28"><span>碳水</span><span id="statCarb" class="font-bold">0g</span></div>
                    <div class="flex justify-between w-28 border-y border-white/10 py-1"><span>蛋白</span><span id="statPro" class="font-bold">0g</span></div>
                    <div class="flex justify-between w-28"><span>脂肪</span><span id="statFat" class="font-bold">0g</span></div>
                </div>
            </div>
        </header>

        <main class="p-6">
            <h3 class="text-xl font-bold mb-4">用餐紀錄</h3>
            <div id="mealList" class="space-y-3"></div>
        </main>

        <div id="searchDrawer" class="fixed inset-0 bg-black/70 z-50 hidden backdrop-blur-md">
            <div id="drawerContent" class="absolute bottom-0 w-full max-w-md bg-white rounded-t-[3rem] p-8 max-h-[90vh] overflow-y-auto transform translate-y-full transition-transform duration-500">
                <div class="w-16 h-1.5 bg-slate-200 rounded-full mx-auto mb-8"></div>
                
                <input type="text" id="foodInput" class="w-full bg-slate-100 rounded-2xl p-4 mb-6 text-xl font-bold outline-none border-2 border-transparent focus:border-indigo-500" placeholder="點擊下方辨識或輸入名稱">

                <div class="grid grid-cols-2 gap-4 mb-8">
                    <label class="group cursor-pointer">
                        <span class="text-[11px] font-bold text-slate-400 block mb-2 ml-1">1. 食品縮圖</span>
                        <div class="h-32 bg-slate-50 border-2 border-dashed border-slate-200 rounded-3xl flex items-center justify-center overflow-hidden relative">
                            <input type="file" class="hidden" accept="image/*" onchange="handleImage(this, 'thumb')">
                            <div id="thumbPreview" class="text-slate-300 group-hover:text-indigo-400 transition-colors"><i class="fas fa-image text-3xl"></i></div>
                        </div>
                    </label>
                    <label class="group cursor-pointer relative">
                        <span class="text-[11px] font-bold text-slate-400 block mb-2 ml-1">2. 營養成分表</span>
                        <div class="h-32 bg-slate-50 border-2 border-dashed border-slate-200 rounded-3xl flex items-center justify-center overflow-hidden relative">
                            <input type="file" class="hidden" accept="image/*" onchange="handleImage(this, 'ocr')">
                            <div id="ocrPreview" class="text-slate-300 group-hover:text-indigo-400 transition-colors"><i class="fas fa-file-alt text-3xl"></i></div>
                            <div id="ocrLoading" class="hidden absolute inset-0 bg-white/90 flex flex-col items-center justify-center">
                                <div class="w-6 h-6 border-2 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                                <span class="text-[10px] mt-2 font-bold text-indigo-600">辨識中...</span>
                            </div>
                        </div>
                    </label>
                </div>

                <div class="bg-indigo-50 rounded-[2.5rem] p-6 space-y-5 mb-8">
                    <div class="flex gap-4">
                        <div class="flex-1">
                            <label class="text-[10px] font-black text-indigo-400 ml-2">熱量 (KCAL)</label>
                            <input type="number" id="inputKcal" class="w-full bg-white rounded-2xl p-4 text-2xl font-black text-indigo-700 outline-none">
                        </div>
                        <div class="w-24">
                            <label class="text-[10px] font-black text-indigo-400 ml-2 text-center block">份數</label>
                            <input type="number" id="inputQty" value="1" class="w-full bg-white rounded-2xl p-4 text-center font-bold outline-none">
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                        <div><label class="text-[9px] font-bold text-indigo-300 block text-center mb-1">碳水 (g)</label><input type="number" id="inputCarb" class="w-full bg-white rounded-xl p-3 text-center font-bold outline-none"></div>
                        <div><label class="text-[9px] font-bold text-indigo-300 block text-center mb-1">蛋白 (g)</label><input type="number" id="inputPro" class="w-full bg-white rounded-xl p-3 text-center font-bold outline-none"></div>
                        <div><label class="text-[9px] font-bold text-indigo-300 block text-center mb-1">脂肪 (g)</label><input type="number" id="inputFat" class="w-full bg-white rounded-xl p-3 text-center font-bold outline-none"></div>
                    </div>
                </div>

                <button onclick="saveToRecord()" class="w-full bg-indigo-600 text-white py-5 rounded-[2rem] font-bold shadow-lg shadow-indigo-100 active:scale-95 transition-all">儲存紀錄</button>
                <button onclick="toggleDrawer(false)" class="w-full py-4 text-slate-400 text-sm font-medium">取消</button>
            </div>
        </div>

        <nav class="fixed bottom-0 max-w-md w-full bg-white border-t p-4 flex justify-around items-center z-40 rounded-t-3xl shadow-2xl">
            <i class="fas fa-home text-indigo-600 text-xl"></i>
            <button onclick="openAddDrawer()" class="w-16 h-16 bg-indigo-600 rounded-full -mt-12 border-[6px] border-white text-white shadow-xl active:scale-90 transition-all"><i class="fas fa-plus text-2xl"></i></button>
            <i class="fas fa-cog text-slate-200 text-xl" onclick="toggleUserModal(true)"></i>
        </nav>
    </div>

    <script>
        let records = JSON.parse(localStorage.getItem('myCaloRecords')) || [];
        let currentThumb = null;

        // --- 強力 OCR 辨識邏輯 ---
        async function runOCR(imgData) {
            const loader = document.getElementById('ocrLoading');
            loader.classList.remove('hidden');
            
            try {
                const result = await Tesseract.recognize(imgData, 'chi_tra+eng');
                const text = result.data.text.replace(/\s+/g, ''); // 移除空格
                console.log("OCR 辨識結果串:", text);

                // 邏輯升級：尋找關鍵字後的第一組數字（支援整數與小數點）
                const parseField = (keywords, elementId) => {
                    for (let key of keywords) {
                        const idx = text.indexOf(key);
                        if (idx !== -1) {
                            // 擷取關鍵字後方的文字內容
                            const afterText = text.substring(idx + key.length, idx + key.length + 12);
                            const match = afterText.match(/(\d+\.?\d*)/); // 找第一個數字
                            if (match) {
                                const input = document.getElementById(elementId);
                                input.value = match[1];
                                input.classList.add('input-success');
                                setTimeout(() => input.classList.remove('input-success'), 1500);
                                return true;
                            }
                        }
                    }
                    return false;
                };

                // 針對味味麵截圖的欄位掃描
                parseField(['熱量', 'Calories', 'Kcal'], 'inputKcal');
                parseField(['蛋白質', 'Protein'], 'inputPro');
                parseField(['脂肪', 'Fat'], 'inputFat');
                parseField(['碳水化合物', '碳水', 'Carb'], 'inputCarb');

                // 名稱識別
                if (text.includes("味味麵")) {
                    const nameInput = document.getElementById('foodInput');
                    nameInput.value = "味味麵";
                    nameInput.classList.add('input-success');
                }
            } catch (err) {
                alert("辨識失敗，請確保圖片清晰");
            } finally {
                loader.classList.add('hidden');
            }
        }

        // --- 基礎功能 ---
        function handleImage(input, type) {
            if (!input.files || !input.files[0]) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                if (type === 'thumb') {
                    currentThumb = e.target.result;
                    document.getElementById('thumbPreview').innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
                } else {
                    document.getElementById('ocrPreview').innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
                    runOCR(e.target.result);
                }
            };
            reader.readAsDataURL(input.files[0]);
        }

        function openAddDrawer() {
            document.querySelectorAll('input').forEach(i => { if(i.id !== 'inputQty') i.value = ''; });
            document.getElementById('thumbPreview').innerHTML = '<i class="fas fa-image text-3xl"></i>';
            document.getElementById('ocrPreview').innerHTML = '<i class="fas fa-file-alt text-3xl"></i>';
            currentThumb = null;
            toggleDrawer(true);
        }

        function toggleDrawer(show) {
            const d = document.getElementById('searchDrawer');
            if(show) { d.classList.remove('hidden'); setTimeout(() => document.getElementById('drawerContent').classList.add('drawer-active'), 10); }
            else { document.getElementById('drawerContent').classList.remove('drawer-active'); setTimeout(() => d.classList.add('hidden'), 500); }
        }

        function saveToRecord() {
            const qty = parseFloat(document.getElementById('inputQty').value) || 1;
            const record = {
                id: Date.now(),
                name: document.getElementById('foodInput').value || "紀錄食品",
                kcal: (parseFloat(document.getElementById('inputKcal').value) || 0) * qty,
                carb: (parseFloat(document.getElementById('inputCarb').value) || 0) * qty,
                pro: (parseFloat(document.getElementById('inputPro').value) || 0) * qty,
                fat: (parseFloat(document.getElementById('inputFat').value) || 0) * qty,
                thumb: currentThumb
            };
            records.push(record);
            localStorage.setItem('myCaloRecords', JSON.stringify(records));
            renderAll();
            toggleDrawer(false);
        }

        function renderAll() {
            const s = records.reduce((a, b) => ({ k: a.k+b.kcal, c: a.c+b.carb, p: a.p+b.pro, f: a.f+b.fat }), { k:0, c:0, p:0, f:0 });
            document.getElementById('displayKcal').innerText = Math.round(s.k);
            document.getElementById('statCarb').innerText = Math.round(s.c) + 'g';
            document.getElementById('statPro').innerText = Math.round(s.p) + 'g';
            document.getElementById('statFat').innerText = Math.round(s.f) + 'g';
            
            const list = document.getElementById('mealList');
            list.innerHTML = records.map(r => `
                <div class="bg-white p-4 rounded-[2rem] shadow-sm border border-slate-100 flex items-center gap-4">
                    <img src="${r.thumb || 'https://via.placeholder.com/100'}" class="w-14 h-14 rounded-2xl object-cover">
                    <div class="flex-1">
                        <h4 class="font-bold">${r.name}</h4>
                        <p class="text-[10px] text-slate-400 font-bold">${Math.round(r.kcal)} kcal</p>
                    </div>
                </div>
            `).join('');
            document.getElementById('headerDate').innerText = new Date().toLocaleDateString();
        }

        window.onload = renderAll;
    </script>
</body>
</html>
