<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyCalo v1.2.0 - 終極精準 OCR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js'></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .input-active { border: 2px solid #6366f1 !important; background-color: #f5f3ff !important; transform: scale(1.02); transition: all 0.3s; }
        .drawer-active { transform: translateY(0) !important; }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900">

    <div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-2xl relative pb-32">
        
        <header class="p-8 bg-gradient-to-br from-blue-700 to-indigo-800 text-white rounded-b-[3rem] shadow-xl">
             <div class="flex justify-between items-center mb-6">
                <div class="text-sm opacity-80" id="headerDate">2026年1月1日</div>
                <i class="fas fa-user-circle text-2xl opacity-80"></i>
            </div>
            <div class="flex flex-col items-center">
                <div class="text-4xl font-black mb-1" id="displayKcal">0</div>
                <div class="text-[10px] tracking-widest opacity-60 uppercase">Total Calories</div>
            </div>
        </header>

        <main class="p-6">
            <div id="mealList" class="space-y-4"></div>
        </main>

        <div id="searchDrawer" class="fixed inset-0 bg-black/80 z-50 hidden backdrop-blur-md">
            <div id="drawerContent" class="absolute bottom-0 w-full max-w-md bg-white rounded-t-[3rem] p-8 transform translate-y-full transition-transform duration-500">
                <div class="w-12 h-1 bg-slate-200 rounded-full mx-auto mb-8"></div>
                
                <input type="text" id="foodInput" class="w-full bg-slate-50 rounded-2xl p-4 mb-6 text-xl font-bold outline-none border-2 border-transparent focus:border-indigo-500" placeholder="食品名稱">

                <div class="grid grid-cols-2 gap-4 mb-8">
                    <label class="h-32 bg-slate-50 border-2 border-dashed border-slate-200 rounded-3xl flex items-center justify-center overflow-hidden relative cursor-pointer">
                        <input type="file" class="hidden" accept="image/*" onchange="handleImage(this, 'thumb')">
                        <div id="thumbPreview" class="text-slate-300 text-center"><i class="fas fa-camera text-2xl mb-1"></i><p class="text-[9px]">食品縮圖</p></div>
                    </label>
                    <label class="h-32 bg-slate-50 border-2 border-dashed border-slate-200 rounded-3xl flex items-center justify-center overflow-hidden relative cursor-pointer">
                        <input type="file" class="hidden" accept="image/*" onchange="handleImage(this, 'ocr')">
                        <div id="ocrPreview" class="text-slate-300 text-center"><i class="fas fa-barcode text-2xl mb-1"></i><p class="text-[9px]">營養標示</p></div>
                        <div id="ocrLoading" class="hidden absolute inset-0 bg-white/95 flex flex-col items-center justify-center">
                            <div class="w-6 h-6 border-2 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                            <span class="text-[10px] mt-2 text-indigo-600 font-bold">精準分析中</span>
                        </div>
                    </label>
                </div>

                <div class="bg-slate-50 rounded-[2.5rem] p-6 space-y-4 mb-8">
                    <div class="flex gap-4">
                        <div class="flex-1">
                            <label class="text-[10px] font-bold text-slate-400 ml-2">熱量 (KCAL)</label>
                            <input type="number" step="0.1" id="inputKcal" class="w-full bg-white rounded-2xl p-4 text-2xl font-black text-indigo-600 outline-none shadow-sm">
                        </div>
                        <div class="w-24">
                            <label class="text-[10px] font-bold text-slate-400 ml-2 text-center block">份數</label>
                            <input type="number" id="inputQty" value="1" class="w-full bg-white rounded-2xl p-4 text-center font-bold outline-none shadow-sm">
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label class="text-[9px] font-bold text-slate-400 block text-center">碳水 (g)</label>
                            <input type="number" step="0.1" id="inputCarb" class="w-full bg-white rounded-xl p-3 text-center font-bold outline-none shadow-sm">
                        </div>
                        <div>
                            <label class="text-[9px] font-bold text-slate-400 block text-center">蛋白 (g)</label>
                            <input type="number" step="0.1" id="inputPro" class="w-full bg-white rounded-xl p-3 text-center font-bold outline-none shadow-sm">
                        </div>
                        <div>
                            <label class="text-[9px] font-bold text-slate-400 block text-center">脂肪 (g)</label>
                            <input type="number" step="0.1" id="inputFat" class="w-full bg-white rounded-xl p-3 text-center font-bold outline-none shadow-sm">
                        </div>
                    </div>
                </div>

                <button onclick="saveRecord()" class="w-full bg-indigo-600 text-white py-5 rounded-[2rem] font-bold shadow-xl active:scale-95 transition-all">確認儲存</button>
            </div>
        </div>

        <nav class="fixed bottom-0 max-w-md w-full bg-white/90 backdrop-blur-md p-6 flex justify-around items-center rounded-t-[2.5rem] shadow-2xl">
            <i class="fas fa-th-large text-slate-300"></i>
            <button onclick="openDrawer()" class="w-14 h-14 bg-indigo-600 rounded-2xl -mt-16 rotate-45 flex items-center justify-center text-white shadow-lg"><i class="fas fa-plus -rotate-45"></i></button>
            <i class="fas fa-chart-line text-slate-300"></i>
        </nav>
    </div>

    <script>
        let records = [];

        async function runOCR(imgData) {
            const loader = document.getElementById('ocrLoading');
            loader.classList.remove('hidden');
            
            try {
                const result = await Tesseract.recognize(imgData, 'chi_tra+eng', {
                    tessedit_char_whitelist: '0123456789.蛋白質熱量脂肪碳水化合物大卡公克g'
                });
                // 移除空格，但保留小數點
                const text = result.data.text.replace(/\s/g, ''); 
                console.log("Cleaned OCR:", text);

                const extract = (keywords, elementId) => {
                    for (let key of keywords) {
                        const regex = new RegExp(`${key}[:：]?([0-9]+\\.?[0-9]*)`);
                        const match = text.match(regex);
                        if (match) {
                            const val = parseFloat(match[1]);
                            const input = document.getElementById(elementId);
                            input.value = val;
                            input.classList.add('input-active');
                            setTimeout(() => input.classList.remove('input-active'), 1000);
                            return true;
                        }
                    }
                    return false;
                };

                // 執行提取
                extract(['熱量', 'Calories'], 'inputKcal');
                extract(['蛋白質', 'Protein'], 'inputPro');
                extract(['脂肪', 'Fat'], 'inputFat');
                extract(['碳水化合物', '碳水', 'Carbohydrate'], 'inputCarb');

                if (text.includes("味味麵")) document.getElementById('foodInput').value = "味味麵";

            } catch (e) {
                console.error(e);
            } finally {
                loader.classList.add('hidden');
            }
        }

        // --- 以下功能保持邏輯完整 ---
        function handleImage(input, type) {
            if (!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                if (type === 'thumb') document.getElementById('thumbPreview').innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
                else {
                    document.getElementById('ocrPreview').innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
                    runOCR(e.target.result);
                }
            };
            reader.readAsDataURL(input.files[0]);
        }

        function openDrawer() {
            document.getElementById('searchDrawer').classList.remove('hidden');
            setTimeout(() => document.getElementById('drawerContent').classList.add('drawer-active'), 10);
        }

        function saveRecord() {
            const kcal = parseFloat(document.getElementById('inputKcal').value) || 0;
            records.push({ name: document.getElementById('foodInput').value || '未知食物', kcal });
            document.getElementById('displayKcal').innerText = records.reduce((a,b)=>a+b.kcal, 0);
            document.getElementById('searchDrawer').classList.add('hidden');
            document.getElementById('drawerContent').classList.remove('drawer-active');
        }
    </script>
</body>
</html>
