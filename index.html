<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyCalo v1.2.5 - 功能整合版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js'></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .drawer-active { transform: translateY(0) !important; }
        .item-deleted { transform: translateX(100px); opacity: 0; transition: all 0.4s; }
        ::-webkit-scrollbar { display: none; }
        /* 增加震動動畫提示可以長按 */
        .press-hint:active { transform: scale(0.98); }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900">

    <div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-2xl relative pb-32">
        
        <header class="p-8 bg-gradient-to-br from-indigo-700 to-blue-600 text-white rounded-b-[3rem] shadow-xl relative">
            <div class="flex justify-between items-center mb-6">
                <div class="text-sm font-medium" id="headerDate">2026年1月1日</div>
                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center"><i class="fas fa-user text-sm"></i></div>
            </div>
            <div class="flex items-center justify-around">
                <div class="relative">
                    <svg class="w-32 h-32 -rotate-90">
                        <circle cx="64" cy="64" r="58" stroke="rgba(255,255,255,0.2)" stroke-width="8" fill="transparent" />
                        <circle id="progressCircle" cx="64" cy="64" r="58" stroke="white" stroke-width="8" fill="transparent" stroke-dasharray="364" stroke-dashoffset="0" stroke-linecap="round" class="transition-all duration-1000" />
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <span id="displayKcal" class="text-3xl font-black">0</span>
                        <p class="text-[10px] opacity-70">今日總攝取</p>
                    </div>
                </div>
                <div class="text-xs space-y-2">
                    <div class="flex justify-between w-24 border-b border-white/10 pb-1"><span>碳水</span><span id="statCarb" class="font-bold">0g</span></div>
                    <div class="flex justify-between w-24 border-b border-white/10 pb-1"><span>蛋白</span><span id="statPro" class="font-bold">0g</span></div>
                    <div class="flex justify-between w-24"><span>脂肪</span><span id="statFat" class="font-bold">0g</span></div>
                </div>
            </div>
        </header>

        <main class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">用餐紀錄</h3>
                <span class="text-[10px] text-slate-400 font-medium">長按項目可刪除</span>
            </div>
            <div id="mealList" class="space-y-3">
                </div>
        </main>

        <div id="searchDrawer" class="fixed inset-0 bg-black/70 z-50 hidden backdrop-blur-md">
            <div id="drawerContent" class="absolute bottom-0 w-full max-w-md bg-white rounded-t-[3rem] p-8 max-h-[90vh] overflow-y-auto transform translate-y-full transition-transform duration-500">
                <div class="w-16 h-1.5 bg-slate-200 rounded-full mx-auto mb-8"></div>
                
                <input type="text" id="foodInput" class="w-full bg-slate-100 rounded-2xl p-4 mb-6 text-xl font-bold outline-none border-2 border-transparent focus:border-indigo-500" placeholder="點擊辨識或輸入名稱">

                <div class="grid grid-cols-2 gap-4 mb-8">
                    <label class="h-32 bg-slate-50 border-2 border-dashed border-slate-200 rounded-3xl flex flex-col items-center justify-center overflow-hidden relative cursor-pointer">
                        <input type="file" class="hidden" accept="image/*" onchange="handleImage(this, 'thumb')">
                        <div id="thumbPreview" class="text-slate-300 text-center"><i class="fas fa-image text-2xl mb-1"></i><p class="text-[10px]">食物封面</p></div>
                    </label>
                    <label class="h-32 bg-slate-50 border-2 border-dashed border-slate-200 rounded-3xl flex flex-col items-center justify-center overflow-hidden relative cursor-pointer">
                        <input type="file" class="hidden" accept="image/*" onchange="handleImage(this, 'ocr')">
                        <div id="ocrPreview" class="text-slate-300 text-center"><i class="fas fa-file-invoice text-2xl mb-1"></i><p class="text-[10px]">營養標示</p></div>
                        <div id="ocrLoading" class="hidden absolute inset-0 bg-white/90 flex flex-col items-center justify-center text-indigo-600">
                            <div class="w-6 h-6 border-2 border-indigo-600 border-t-transparent rounded-full animate-spin mb-2"></div>
                            <span class="text-[10px] font-bold">精確分析中...</span>
                        </div>
                    </label>
                </div>

                <div class="bg-indigo-50 rounded-[2.5rem] p-6 space-y-5 mb-8">
                    <div class="flex gap-4">
                        <div class="flex-1">
                            <label class="text-[10px] font-black text-indigo-400 ml-2">熱量 (KCAL)</label>
                            <input type="number" step="0.1" id="inputKcal" class="w-full bg-white rounded-2xl p-4 text-2xl font-black text-indigo-700 outline-none">
                        </div>
                        <div class="w-24">
                            <label class="text-[10px] font-black text-indigo-400 ml-2 text-center block">份數</label>
                            <input type="number" id="inputQty" value="1" class="w-full bg-white rounded-2xl p-4 text-center font-bold outline-none">
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                        <div><label class="text-[9px] font-bold text-indigo-300 block text-center mb-1">碳水(g)</label><input type="number" step="0.1" id="inputCarb" class="w-full bg-white rounded-xl p-3 text-center font-bold outline-none text-indigo-600"></div>
                        <div><label class="text-[9px] font-bold text-indigo-300 block text-center mb-1">蛋白(g)</label><input type="number" step="0.1" id="inputPro" class="w-full bg-white rounded-xl p-3 text-center font-bold outline-none text-indigo-600"></div>
                        <div><label class="text-[9px] font-bold text-indigo-300 block text-center mb-1">脂肪(g)</label><input type="number" step="0.1" id="inputFat" class="w-full bg-white rounded-xl p-3 text-center font-bold outline-none text-indigo-600"></div>
                    </div>
                </div>

                <button onclick="saveToRecord()" class="w-full bg-indigo-600 text-white py-5 rounded-[2rem] font-bold shadow-lg shadow-indigo-100 active:scale-95 transition-all">確認儲存</button>
                <button onclick="toggleDrawer(false)" class="w-full py-4 text-slate-400 text-sm font-medium">取消</button>
            </div>
        </div>

        <nav class="fixed bottom-0 max-w-md w-full bg-white border-t p-4 flex justify-around items-center z-40 rounded-t-3xl">
            <i class="fas fa-home text-indigo-600 text-xl"></i>
            <button onclick="openAddDrawer()" class="w-16 h-16 bg-indigo-600 rounded-full -mt-12 border-[6px] border-white text-white shadow-xl active:scale-90 transition-all"><i class="fas fa-plus text-2xl"></i></button>
            <i class="fas fa-history text-slate-200 text-xl"></i>
        </nav>
    </div>

    <script>
        let records = JSON.parse(localStorage.getItem('myCaloRecords')) || [];
        let currentThumb = null;

        // --- OCR 辨識邏輯 (v1.2.5 強化版) ---
        async function runOCR(imgData) {
            const loader = document.getElementById('ocrLoading');
            loader.classList.remove('hidden');
            try {
                const result = await Tesseract.recognize(imgData, 'chi_tra+eng');
                const text = result.data.text.replace(/\s+/g, '');
                console.log("OCR Text:", text);

                const parseField = (keywords, elementId) => {
                    for (let key of keywords) {
                        const regex = new RegExp(`${key}[:：]?([0-9]+\\.?[0-9]*)`);
                        const match = text.match(regex);
                        if (match) {
                            document.getElementById(elementId).value = match[1];
                            return true;
                        }
                    }
                    return false;
                };

                parseField(['熱量', 'Calories'], 'inputKcal');
                parseField(['蛋白質', 'Protein'], 'inputPro');
                parseField(['脂肪', 'Fat'], 'inputFat');
                parseField(['碳水化合物', '碳水', 'Carb'], 'inputCarb');

                if (text.includes("味味麵")) document.getElementById('foodInput').value = "味味麵";
            } catch (err) { alert("辨識失敗"); }
            finally { loader.classList.add('hidden'); }
        }

        // --- 核心功能：渲染與刪除 ---
        function renderAll() {
            const totals = records.reduce((a, b) => ({
                k: a.k + (parseFloat(b.kcal) || 0),
                c: a.c + (parseFloat(b.carb) || 0),
                p: a.p + (parseFloat(b.pro) || 0),
                f: a.f + (parseFloat(b.fat) || 0)
            }), { k:0, c:0, p:0, f:0 });

            document.getElementById('displayKcal').innerText = Math.round(totals.k);
            document.getElementById('statCarb').innerText = totals.c.toFixed(1) + 'g';
            document.getElementById('statPro').innerText = totals.p.toFixed(1) + 'g';
            document.getElementById('statFat').innerText = totals.f.toFixed(1) + 'g';

            const list = document.getElementById('mealList');
            list.innerHTML = records.map((r, index) => `
                <div class="bg-white p-4 rounded-3xl shadow-sm border border-slate-100 flex items-center gap-4 press-hint active:bg-slate-50 transition-all" 
                     oncontextmenu="deleteRecord(${index}); return false;" 
                     id="item-${index}">
                    <img src="${r.thumb || 'https://via.placeholder.com/100'}" class="w-14 h-14 rounded-2xl object-cover bg-slate-100">
                    <div class="flex-1">
                        <h4 class="font-bold text-slate-700">${r.name}</h4>
                        <p class="text-[10px] text-slate-400 font-bold">${r.kcal} kcal | ${r.pro}g 蛋白</p>
                    </div>
                    <div class="text-indigo-600 font-black">×1</div>
                </div>
            `).join('');
            
            localStorage.setItem('myCaloRecords', JSON.stringify(records));
        }

        function deleteRecord(index) {
            if(confirm('確定要刪除這筆紀錄嗎？')) {
                const el = document.getElementById(`item-${index}`);
                el.classList.add('item-deleted');
                setTimeout(() => {
                    records.splice(index, 1);
                    renderAll();
                }, 400);
            }
        }

        // --- 抽屜控制 ---
        function openAddDrawer() {
            document.querySelectorAll('#drawerContent input').forEach(i => i.id === 'inputQty' ? i.value=1 : i.value='');
            document.getElementById('thumbPreview').innerHTML = '<i class="fas fa-image text-2xl mb-1"></i><p class="text-[10px]">食物封面</p>';
            document.getElementById('ocrPreview').innerHTML = '<i class="fas fa-file-invoice text-2xl mb-1"></i><p class="text-[10px]">營養標示</p>';
            currentThumb = null;
            toggleDrawer(true);
        }

        function toggleDrawer(show) {
            const d = document.getElementById('searchDrawer');
            if(show) { d.classList.remove('hidden'); setTimeout(() => document.getElementById('drawerContent').classList.add('drawer-active'), 10); }
            else { document.getElementById('drawerContent').classList.remove('drawer-active'); setTimeout(() => d.classList.add('hidden'), 500); }
        }

        function handleImage(input, type) {
            if (!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                if (type === 'thumb') {
                    currentThumb = e.target.result;
                    document.getElementById('thumbPreview').innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
                } else {
                    document.getElementById('ocrPreview').innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
                    runOCR(e.target.result);
                }
            };
            reader.readAsDataURL(input.files[0]);
        }

        function saveToRecord() {
            const qty = parseFloat(document.getElementById('inputQty').value) || 1;
            records.push({
                name: document.getElementById('foodInput').value || "紀錄食品",
                kcal: (parseFloat(document.getElementById('inputKcal').value) || 0) * qty,
                carb: (parseFloat(document.getElementById('inputCarb').value) || 0) * qty,
                pro: (parseFloat(document.getElementById('inputPro').value) || 0) * qty,
                fat: (parseFloat(document.getElementById('inputFat').value) || 0) * qty,
                thumb: currentThumb
            });
            renderAll();
            toggleDrawer(false);
        }

        window.onload = renderAll;
    </script>
</body>
</html>
