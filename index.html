<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyCalo v1.0.5 - 長按刪除與UI優化</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        ::-webkit-scrollbar { display: none; }
        .drawer-active { transform: translateY(0) !important; }
        /* 增加刪除時的動畫 */
        .item-deleted { transform: translateX(100%); opacity: 0; transition: all 0.4s ease; }
        /* 防止長按選取文字 */
        .no-select { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900 no-select">

    <div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-2xl relative pb-32">
        
        <header class="p-8 bg-gradient-to-br from-indigo-600 to-blue-500 text-white rounded-b-[2.5rem] shadow-xl">
            <div class="flex justify-between items-center mb-6">
                <div class="text-sm font-light opacity-90" id="headerDate">2026年1月1日 星期四</div>
                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center"><i class="fas fa-user text-lg"></i></div>
            </div>
            <div class="flex items-center justify-around">
                <div class="text-center relative">
                    <svg class="w-32 h-32 -rotate-90">
                        <circle cx="64" cy="64" r="58" stroke="rgba(255,255,255,0.2)" stroke-width="8" fill="transparent" />
                        <circle id="progressCircle" cx="64" cy="64" r="58" stroke="white" stroke-width="8" fill="transparent" 
                            stroke-dasharray="364" stroke-dashoffset="364" stroke-linecap="round" class="transition-all duration-700" />
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <span id="displayKcal" class="text-3xl font-bold">0</span>
                        <p class="text-[10px] opacity-80 uppercase">今日消耗 kcal</p>
                    </div>
                </div>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between w-32 border-b border-white/10 pb-1"><span>碳水</span><span id="statCarb" class="font-bold">0g</span></div>
                    <div class="flex justify-between w-32 border-b border-white/10 pb-1"><span>蛋白質</span><span id="statPro" class="font-bold">0g</span></div>
                    <div class="flex justify-between w-32"><span>脂肪</span><span id="statFat" class="font-bold">0g</span></div>
                </div>
            </div>
        </header>

        <main class="p-6 space-y-4">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-xl font-bold text-gray-800">用餐紀錄</h3>
                <span class="text-[10px] text-gray-400 font-normal">長按項目可刪除紀錄</span>
            </div>
            <div id="mealList" class="space-y-3">
                <div id="emptyState" class="text-center py-10 text-gray-400 italic text-sm">尚未有今日紀錄</div>
            </div>
        </main>

        <div id="searchDrawer" class="fixed inset-0 bg-black/60 z-50 hidden backdrop-blur-sm transition-opacity duration-300">
            <div id="drawerContent" class="absolute bottom-0 w-full max-w-md bg-white rounded-t-[2.5rem] p-6 max-h-[90vh] overflow-y-auto transform translate-y-full transition-transform duration-500">
                <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
                
                <h2 class="text-2xl font-bold mb-4">記錄食品資訊</h2>
                
                <div class="space-y-3 mb-6">
                    <input type="text" id="foodInput" class="w-full bg-gray-100 rounded-xl p-4 outline-none border-2 border-transparent focus:border-indigo-400" placeholder="食物名稱">
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="searchGoogle()" class="bg-white border p-3 rounded-xl shadow-sm active:scale-95 transition-all flex items-center justify-center">
                            <img src="https://www.google.com/favicon.ico" class="w-4 h-4 mr-2"> Google 搜尋
                        </button>
                        <label class="bg-white border p-3 rounded-xl shadow-sm active:scale-95 transition-all flex items-center justify-center cursor-pointer">
                            <i class="fas fa-images mr-2 text-indigo-500"></i> 參考截圖
                            <input type="file" id="screenshotUpload" class="hidden" accept="image/*" multiple onchange="handleImageUpload(this)">
                        </label>
                    </div>
                </div>

                <div id="imagePreviewContainer" class="flex gap-2 overflow-x-auto mb-6 hidden"></div>

                <div class="bg-indigo-50 p-5 rounded-3xl space-y-4 mb-6 border border-indigo-100">
                    <div class="flex items-center gap-4">
                        <div class="flex-1">
                            <label class="text-[10px] text-indigo-400 font-bold ml-1">熱量 (Kcal)</label>
                            <input type="number" id="inputKcal" class="w-full bg-white rounded-xl p-3 outline-none text-xl font-bold text-indigo-600" placeholder="0">
                        </div>
                        <div class="w-24 text-center">
                            <label class="text-[10px] text-indigo-400 font-bold">份數</label>
                            <input type="number" id="inputQty" value="1" class="w-full bg-white rounded-xl p-3 outline-none text-center font-bold">
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                        <input type="number" id="inputCarb" class="w-full bg-white rounded-xl p-2 text-center" placeholder="碳水">
                        <input type="number" id="inputPro" class="w-full bg-white rounded-xl p-2 text-center" placeholder="蛋白">
                        <input type="number" id="inputFat" class="w-full bg-white rounded-xl p-2 text-center" placeholder="脂肪">
                    </div>
                </div>

                <button onclick="saveToRecord()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-indigo-200 active:scale-95 transition-all mb-4">完成儲存</button>
                <button onclick="toggleDrawer(false)" class="w-full text-gray-400 text-sm">取消</button>
            </div>
        </div>

        <div class="fixed bottom-1 left-1 z-[1] pointer-events-none opacity-30">
            <span class="text-[8px] text-gray-400 font-mono">v1.0.5-beta</span>
        </div>
        
        <nav class="fixed bottom-0 max-w-md w-full bg-white/90 backdrop-blur-md border-t border-gray-100 p-4 flex justify-around items-center z-[40]">
            <i class="fas fa-home text-indigo-500 text-xl"></i>
            <div onclick="toggleDrawer(true)" class="w-12 h-12 bg-indigo-500 rounded-full -mt-10 border-4 border-white flex items-center justify-center text-white shadow-lg cursor-pointer"><i class="fas fa-plus"></i></div>
            <i class="fas fa-cog text-gray-300 text-xl"></i>
        </nav>
    </div>

    <script>
        let dailyStats = { kcal: 0, carb: 0, pro: 0, fat: 0 };
        let records = [];

        function toggleDrawer(show) {
            const drawer = document.getElementById('searchDrawer');
            const content = document.getElementById('drawerContent');
            if (show) {
                drawer.classList.remove('hidden');
                setTimeout(() => { drawer.classList.add('opacity-100'); content.classList.add('drawer-active'); }, 10);
            } else {
                drawer.classList.remove('opacity-100');
                content.classList.remove('drawer-active');
                setTimeout(() => drawer.classList.add('hidden'), 500);
            }
        }

        function searchGoogle() {
            const q = document.getElementById('foodInput').value || "食品";
            window.open(`https://www.google.com/search?q=${encodeURIComponent(q + ' 熱量 營養成分')}`, '_blank');
        }

        function handleImageUpload(input) {
            const container = document.getElementById('imagePreviewContainer');
            container.innerHTML = '';
            if (input.files.length > 0) {
                container.classList.remove('hidden');
                Array.from(input.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'w-24 h-24 object-cover rounded-xl border shadow-sm';
                        container.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                });
            }
        }

        function saveToRecord() {
            const inputName = document.getElementById('foodInput').value.trim();
            const name = inputName || "紀錄食品-" + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const qty = parseFloat(document.getElementById('inputQty').value) || 1;
            
            const record = {
                id: Date.now(),
                name: name,
                kcal: (parseFloat(document.getElementById('inputKcal').value) || 0) * qty,
                carb: (parseFloat(document.getElementById('inputCarb').value) || 0) * qty,
                pro: (parseFloat(document.getElementById('inputPro').value) || 0) * qty,
                fat: (parseFloat(document.getElementById('inputFat').value) || 0) * qty
            };

            records.push(record);
            updateDailyStats(record.kcal, record.carb, record.pro, record.fat);
            renderList();
            toggleDrawer(false);
            
            // 重置輸入
            document.getElementById('foodInput').value = "";
            document.getElementById('inputKcal').value = "";
        }

        function updateDailyStats(kcal, carb, pro, fat) {
            dailyStats.kcal += kcal;
            dailyStats.carb += carb;
            dailyStats.pro += pro;
            dailyStats.fat += fat;
            refreshHeader();
        }

        function refreshHeader() {
            document.getElementById('displayKcal').innerText = Math.round(dailyStats.kcal);
            document.getElementById('statCarb').innerText = Math.round(dailyStats.carb) + 'g';
            document.getElementById('statPro').innerText = Math.round(dailyStats.pro) + 'g';
            document.getElementById('statFat').innerText = Math.round(dailyStats.fat) + 'g';
            const offset = 364 - (Math.min(dailyStats.kcal, 2000) / 2000 * 364);
            document.getElementById('progressCircle').style.strokeDashoffset = offset;
        }

        function renderList() {
            const list = document.getElementById('mealList');
            list.innerHTML = records.length === 0 ? '<div id="emptyState" class="text-center py-10 text-gray-400 italic text-sm">尚未有今日紀錄</div>' : '';
            
            records.slice().reverse().forEach(record => {
                const item = document.createElement('div');
                item.className = "bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center transition-all active:bg-gray-50 cursor-pointer";
                item.innerHTML = `<div><div class="font-bold text-slate-700">${record.name}</div><div class="text-[10px] text-gray-400">長按刪除</div></div><div class="text-indigo-600 font-bold">${Math.round(record.kcal)} kcal</div>`;
                
                // 實作長按邏輯
                let timer;
                item.addEventListener('touchstart', () => { timer = setTimeout(() => deleteRecord(record.id, item), 800); });
                item.addEventListener('touchend', () => { clearTimeout(timer); });
                item.addEventListener('mousedown', () => { timer = setTimeout(() => deleteRecord(record.id, item), 800); });
                item.addEventListener('mouseup', () => { clearTimeout(timer); });

                list.appendChild(item);
            });
        }

        function deleteRecord(id, element) {
            if(!confirm("確定要刪除這筆紀錄嗎？")) return;
            
            const index = records.findIndex(r => r.id === id);
            if (index > -1) {
                const r = records[index];
                updateDailyStats(-r.kcal, -r.carb, -r.pro, -r.fat);
                records.splice(index, 1);
                element.classList.add('item-deleted');
                setTimeout(() => renderList(), 400);
            }
        }

        document.getElementById('headerDate').innerText = new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
    </script>
</body>
</html>
